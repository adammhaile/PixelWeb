<html>

<head>
    <!-- <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes" /> -->
    <link rel="stylesheet" href="semantic/dist/semantic.min.css">
    <link rel="stylesheet" href="css/spectrum.css">
    <link rel="stylesheet" href="css/ui.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.numeric.min.js"></script>
    <script src="semantic/dist/semantic.min.js"></script>
    <script src="js/spectrum.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/core.js"></script>
    <script src="js/api.js"></script>
    <script src="js/api.calls.js"></script>
    <script src="js/main.js"></script>
    <script src="js/bp.js"></script>
    <script>

    var _curConfig = null;

    var _drivers = null;
    var driverPickers = [];

    var _controllers = null;
    var $controller = null;

    var _anims = null;
    var _animRun = null;
    var $anims = null;

    var $server_config = null;

    function clearDriverChoosers() {
        $("#driver").empty();
        driverPickers = [];
    }

    function addDriverChooser(params) {
        var id = "driver_" + driverPickers.length;
        $("#driver").append('<div id="' + id + '"></div>');
        $("#driver").append('<div class="ui hidden divider short"></div>');
        var $d = $("#driver").children("#" + id);
        $d = $d.param_loader({
            data: _drivers,
            label: "Driver",
            placeholder: "Select Driver...",
            // default: "visualizer"
        });
        if (params) {
            setTimeout(function() {
                $d.val(params);
            }, 5);
        }

        driverPickers.push($d);
    }

    function loadAnimOptions(data, run) {
        $anims = $("#anims").param_loader({
            data: data,
            run: run,
            label: "Animation",
            placeholder: "Select Animation...",
        });
    }

    function filterAnims(val) {
        loadAnimOptions(_anims[val], _animRun);
    }

    function getCurrentConfig() {
        var drivers = [];
        $.each(driverPickers, function(i, d) {
            drivers.push(d.val());
        });
        var cont = $controller.val();

        return {
            drivers: drivers,
            controller: cont
        };
    }

    function getAnimConfig() {
        var config = $anims.val();
        return config;
    }

    function displayCurConfig(){
        if (_curConfig.driver) {
            clearDriverChoosers();
            $.each(_curConfig.driver, function(i, d) {
                addDriverChooser(d);
            });
            // $.each(_curConfig.driver, function(i, d){
            //     driverPickers[i].val(d);
            // });
        }
        if (_curConfig.controller) {
            $controller.val(_curConfig.controller);
        }
    }

    function showBPError(msg){
        $("#bpErrorMsg").html(msg);
        $("#BPError").modal({blurring:true}).modal('show');
    }

    function setLoading(id, state){
        if(state || state === undefined){
            $(id).addClass('loading');
        }
        else {
            $(id).removeClass('loading');
        }
    }

    $(document)
        .ready(function() {

            $("#loadDimmer").dimmer('show');
            $('.menu .item')
                .tab();

            setLoading("body");
            getDrivers(function(drivers) {
                _drivers = drivers;
                clearDriverChoosers();
                addDriverChooser();
                getAnims(function(anims) {
                    _anims = anims.anims;
                    _animRun = anims.run;
                    loadAnimOptions(null);
                    getControllers(function(controllers) {
                        _controllers = controllers;
                        $controller = $("#controller").param_loader({
                            data: controllers,
                            label: "Controller",
                            placeholder: "Select Controller...",
                            default: "matrix",
                            onChange: filterAnims
                        });

                        getConfig(function(config) {
                            _curConfig = config;
                            setLoading("body", false);

                            setTimeout(function(){$("#loadDimmer").dimmer('hide');}, 1000);
                        });
                    });
                });
            });

            setTimeout(displayCurConfig, 1000);

            getServerConfig(function(srv) {
                console.log(srv);
                $server_config = $("#server_config").param_loader({
                    data: [srv.setup],
                    label: "",
                    placeholder: "",
                    disable_option: true,
                    default: "server_config"
                });

                setTimeout(function(){$server_config.val(srv.config);}, 5);
            });

            $('.ui.accordion').accordion({
                exclusive: false
            });

            $("#startDriver").click(function() {

                setLoading("#startDriver");
                var config = getCurrentConfig();
                console.log(config);
                config.action = "startConfig"
                callAPI(config, function(result) {
                    console.log(result);
                    if(result.status){

                    }
                    else {
                        showBPError(result.msg);
                    }
                    setLoading("#startDriver", false);
                });
            });

            $("#startAnim").click(function() {
                setLoading("#startAnim");
                var params = getAnimConfig();
                callAPI({
                    action: "startAnim",
                    config: {
                        id: params.id,
                        config: params.config
                    },
                    run: params.run
                }, function(result) {
                    console.log(result);
                    if(result.status){

                    }
                    else {
                        showBPError(result.msg);
                    }
                    setLoading("#startAnim", false);
                });
            });

            $("#stopAnim").click(function() {
                setLoading("#stopAnim");
                var params = getAnimConfig();
                callAPI({
                    action: "stopAnim"
                }, function(result) {
                    console.log(result);
                    if(result.status){

                    }
                    else {
                        showBPError(result.msg);
                    }
                    setLoading("#stopAnim", false);
                });
            });

            $("#saveServerConfig").click(function() {
                var config = $server_config.val();
                saveServerConfig(config.config, function(result){
                    console.log(result);
                    alert("Save Complete! Please restart server.")
                });
            });
        });
    </script>
</head>

<body class="ui blurring">
    <div class="ui dimmer" id="loadDimmer">
        <div class="ui large text loader">Loading</div>
    </div>
    <div class="ui top attached tabular menu">
        <a class="active item" data-tab="config_tab">Config</a>
        <a class="item" data-tab="anim_tab">Animation</a>
        <a class="item" data-tab="server_tab">Server Config</a>
    </div>
    <div class="ui bottom attached active tab segment" data-tab="config_tab" id="tabConfig">
        <div id="driver"></div>
        <div class="ui hidden divider short"></div>
        <div id="controller"></div>
        <div class="ui hidden divider short"></div>
        <div class="ui button green" id="startDriver">Start</div>
    </div>
    <div class="ui bottom attached tab segment" data-tab="anim_tab" id="tabAnim">
        <div id="anims"></div>
        <div class="ui hidden divider short"></div>
        <div class="ui button green" id="startAnim">Start</div>
        <div class="ui button red" id="stopAnim">Stop</div>
    </div>
    <div class="ui bottom attached tab segment" data-tab="server_tab" id="tabServer">
        <div id="server_config"></div>
        <div class="ui button green" id="saveServerConfig">Save</div>
    </div>

    <div class="ui basic small modal" id="BPError">
        <div class="header">BiblioPixel Error</div>
        <div class="image content">
            <img class="image"><i class="huge red warning sign icon"></i></img>
            <p class="" id="bpErrorMsg"></p>
        </div>
        <div class="actions">
            <div class="ui approve button">OK</div>
        </div>
    </div>

    <div class="ui basic Large modal" id="BPError">
        <div class="header">PixelWeb Status</div>
        <div class="image content">
            <img class="image"><i class="huge red warning sign icon"></i></img>
            <p class="" id="bpErrorMsg"></p>
        </div>
        <div class="actions">
            <div class="ui approve button">OK</div>
        </div>
    </div>
</body>

</html>
